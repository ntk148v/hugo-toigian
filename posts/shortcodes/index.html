<!doctype html><html><head><meta charset=utf-8><title>Toigian
| Hugo Shortcodes</title><meta name=author content="map[email:kiennt2609@gmail.com name:Kien Nguyen-Tuan]"><meta name=description content><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/hugo-toigian/favicon_io/favicon.ico type=image/x-icon><link rel=icon href=/hugo-toigian/favicon_io/favicon-16x16.png size=16x16 type=image/png><link rel=icon href=/hugo-toigian/favicon_io/favicon-32x32.png size=32x32 type=image/png><link rel=alternate type=application/rss+xml href=https://ntk148v.github.io/hugo-toigian/index.xml title=Toigian><link rel=preload type=text/css href=/hugo-toigian/css/rose-pine.min.css integrity as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet type=text/css href=/hugo-toigian/css/rose-pine.min.css integrity></noscript><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;500;700&display=swap" rel=stylesheet><link rel=preload type=text/css href="/hugo-toigian/css/toigian.min.b4d4e99fd1d7985132c42edc204b8306cc21365f9a2ad5eb3c7a334ca7643a8b.css" integrity="sha256-tNTpn9HXmFEyxC7cIEuDBswhNl+aKtXrPHozTKdkOos=" as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet type=text/css href="/hugo-toigian/css/toigian.min.b4d4e99fd1d7985132c42edc204b8306cc21365f9a2ad5eb3c7a334ca7643a8b.css" integrity="sha256-tNTpn9HXmFEyxC7cIEuDBswhNl+aKtXrPHozTKdkOos="></noscript><link rel=stylesheet type=text/css href="/hugo-toigian/css/light.min.29febe5c26ca625f7e2913e2509889a65637f415171eb003603102dea7cc42e0.css" integrity="sha256-Kf6+XCbKYl9+KRPiUJiJplY39BUXHrADYDEC3qfMQuA="><link rel=stylesheet type=text/css href="/hugo-toigian/css/dark.min.47fea451289f4f246c4875ba0aa5f6376183f220c766f5e90d15d6e48cb7b937.css" integrity="sha256-R/6kUSifTyRsSHW6CqX2N2GD8iDHZvXpDRXW5Iy3uTc="><script>localStorage.theme==="dark"||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><script defer src=/hugo-toigian/js/main.dfa968b06ebe7fb755eb156f7296445f20bd5ca0c82aa2eb755b1bfac4e2f294676471cf7670590073c364901a0dd5dc4b4c7b83f7a4a3c3b081f085c78fa1de.js integrity="sha512-36losG6+f7dV6xVvcpZEXyC9XKDIKqLrdVsb+sTi8pRnZHHPdnBZAHPDZJAaDdXcS0x7g/eko8OwgfCFx4+h3g=="></script>
<script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script>mermaid.initialize({startOnLoad:!0,securityLevel:"loose"})</script></head><body><header style=--layer:10><div aria-hidden=true class="absolute top-[-1000px] left-0 z-[calc(var(--layer)+1)] h-[calc(1000px+var(--page-top))] w-full bg-base"></div><div class="fixed top-0 left-0 z-[var(--layer)] flex h-header-height w-full items-center border-b px-page-gutter before:absolute before:inset-0 before:z-[-1] before:bg-base [@supports(backdrop-filter:blur(0))]:before:bg-base [@supports(backdrop-filter:blur(0))]:before:backdrop-blur-md"><div class="lowercase italic mx-auto flex w-full max-w-content items-center justify-between"><nav><ol class="flex text-md items-center"><li><a href=/hugo-toigian/ class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">Toigian</a></li><li class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">/</li><li><a href=/hugo-toigian/posts/ class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">Posts</a></li><li class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">/</li><li><a href=/hugo-toigian/posts/shortcodes/ class="focus:underline focus:outline-none font-bold after:md:mx-2 after:mx-0.5">Hugo Shortcodes</a></li></ol></nav><nav><a href=https://ntk148v.github.io/hugo-toigian/index.xml><svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 19.5v-.75a7.5 7.5.0 00-7.5-7.5H4.5m0-6.75h.75c7.87.0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75.0 11-1.5.0.75.75.0 011.5.0z"/></svg></a></nav></div></div></header><main class="flex justify-center px-page-gutter py-page-top"><div class="min-h-content w-full max-w-content space-y-10 sm:space-y-20"><div class="lowercase italic mx-auto flex w-full max-w-content items-center justify-between"><nav><ol class="flex text-md items-center"><li><a href=/hugo-toigian/ class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">Toigian</a></li><li class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">/</li><li><a href=/hugo-toigian/posts/ class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">Posts</a></li><li class="text-muted focus:underline focus:outline-none after:md:mx-2 after:mx-0.5">/</li><li><a href=/hugo-toigian/posts/shortcodes/ class="focus:underline focus:outline-none font-bold after:md:mx-2 after:mx-0.5">Hugo Shortcodes</a></li></ol></nav><nav><a href=https://ntk148v.github.io/hugo-toigian/index.xml><svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 19.5v-.75a7.5 7.5.0 00-7.5-7.5H4.5m0-6.75h.75c7.87.0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75.0 11-1.5.0.75.75.0 011.5.0z"/></svg></a></nav></div><article><h1>Hugo Shortcodes</h1><time class="text-sm italic tabular-nums text-muted">2022/10/21&nbsp;</time>
<nobr class="text-sm text-muted">&#8674&nbsp;</nobr><time class="text-sm italic tabular-nums text-muted">2023/03/20&nbsp;</time><div class=section><a href=/hugo-toigian/tags/hugo/ id=tag>hugo</a>
<a href=/hugo-toigian/tags/tech/ id=tag>tech</a>
<a href=/hugo-toigian/tags/shortcode/ id=tag>shortcode</a></div><details><summary>Table of contents</summary><div id=toc-list><nav id=TableOfContents><ol><li><a href=#details>Details</a><ol><li><a href=#example>Example</a></li></ol></li><li><a href=#quote>Quote</a><ol><li><a href=#example-1>Example</a></li></ol></li><li><a href=#mermaid>Mermaid</a><ol><li><a href=#example-2>Example</a></li></ol></li><li><a href=#remote-github>Remote Github</a><ol><li><a href=#example-3>Example</a></li></ol></li></ol></nav></div></details><div class=content><h2 id=details>Details</h2><p>Details shortcode is a helper for <code>details</code> html5 element. It is going to replace <code>expand</code> shortcode.</p><h3 id=example>Example</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-tpl data-lang=tpl><span class=line><span class=cl><span class=cp>{{</span><span class=o>&lt;</span> <span class=na>details</span> <span class=s2>&#34;Title&#34;</span> <span class=o>[</span><span class=na>open</span><span class=o>]</span> <span class=o>&gt;</span><span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>## Markdown content
</span></span></span><span class=line><span class=cl><span class=x>Lorem markdownum insigne...
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span><span class=o>&lt;</span> <span class=o>/</span><span class=na>details</span> <span class=o>&gt;</span><span class=cp>}}</span><span class=x>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-tpl data-lang=tpl><span class=line><span class=cl><span class=cp>{{</span><span class=o>&lt;</span> <span class=na>details</span> <span class=na>title</span><span class=o>=</span><span class=s2>&#34;Title&#34;</span> <span class=na>open</span><span class=o>=</span><span class=kc>true</span> <span class=o>&gt;</span><span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>## Markdown content
</span></span></span><span class=line><span class=cl><span class=x>Lorem markdownum insigne...
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span><span class=o>&lt;</span> <span class=o>/</span><span class=na>details</span> <span class=o>&gt;</span><span class=cp>}}</span><span class=x>
</span></span></span></code></pre></div><details><summary>Title</summary><div><h2 id=markdown-content>Markdown content</h2><p>Lorem markdownum insigne&mldr;</div></details><h2 id=quote>Quote</h2><p>Quote shortcode can be used with 3 colors: <code>info</code>, <code>warn</code> and <code>critical</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tpl data-lang=tpl><span class=line><span class=cl><span class=cp>{{</span><span class=o>&lt;</span> <span class=na>quote</span> <span class=o>[</span><span class=na>info</span><span class=o>|</span><span class=na>warn</span><span class=o>|</span><span class=na>critical</span><span class=o>]</span> <span class=o>&gt;</span><span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>**Markdown content**
</span></span></span><span class=line><span class=cl><span class=x>Lorem markdownum insigne. Olympo signis Delphis! Retexi Nereius nova develat
</span></span></span><span class=line><span class=cl><span class=x>stringit, frustra Saturnius uteroque inter! Oculis non ritibus Telethusa
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span><span class=o>&lt;</span> <span class=o>/</span><span class=na>quote</span> <span class=o>&gt;</span><span class=cp>}}</span><span class=x>
</span></span></span></code></pre></div><h3 id=example-1>Example</h3><blockquote class="my-5 p-4 rounded border-solid border-2 border-foam"><strong>Markdown content</strong>
Lorem markdownum insigne. Olympo signis Delphis! Retexi Nereius nova develat
stringit, frustra Saturnius uteroque inter! Oculis non ritibus Telethusa</blockquote><blockquote class="my-5 p-4 rounded border-solid border-2 border-gold"><strong>Markdown content</strong>
Lorem markdownum insigne. Olympo signis Delphis! Retexi Nereius nova develat
stringit, frustra Saturnius uteroque inter! Oculis non ritibus Telethusa</blockquote><blockquote class="my-5 p-4 rounded border-solid border-2 border-love"><strong>Markdown content</strong>
Lorem markdownum insigne. Olympo signis Delphis! Retexi Nereius nova develat
stringit, frustra Saturnius uteroque inter! Oculis non ritibus Telethusa</blockquote><h2 id=mermaid>Mermaid</h2><p><a href=https://mermaidjs.github.io/>Mermaid</a> is a library helping you to generate diagram and flowcharts from text, in a similar manner as Markdown.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tpl data-lang=tpl><span class=line><span class=cl><span class=cp>{{</span><span class=o>&lt;</span> <span class=na>mermaid</span> <span class=o>&gt;</span><span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span><span class=o>&lt;</span> <span class=o>/</span><span class=na>mermaid</span> <span class=o>&gt;</span><span class=cp>}}</span><span class=x>
</span></span></span></code></pre></div><h3 id=example-2>Example</h3><div class=mermaid align=center>sequenceDiagram
participant Alice
participant Bob
Alice->>John: Hello John, how are you?
loop Healthcheck
John->>John: Fight against hypochondria
end
Note right of John: Rational thoughts<br>prevail!
John-->>Alice: Great!
John->>Bob: How about you?
Bob-->>John: Jolly good!</div><h2 id=remote-github>Remote Github</h2><p>Hugo is great in many ways. However as a static site generator it doesn’t offer much to embed external content in your pages. Remote-github shortcode helps you to render Github remote content using <a href="https://docs.github.com/en/rest/repos/contents?apiVersion=2022-11-28#get-repository-content">Github API</a>.</p><p>This shortcode is inspired from <a href=https://discourse.gohugo.io/t/include-content-of-a-url/27357>this issue</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tpl data-lang=tpl><span class=line><span class=cl><span class=cp>{{</span><span class=o>%</span> <span class=na>remote</span><span class=o>-</span><span class=na>github</span> <span class=s2>&#34;user/repo&#34;</span> <span class=s2>&#34;filepath&#34;</span> <span class=o>%</span><span class=cp>}}</span><span class=x>
</span></span></span></code></pre></div><h3 id=example-3>Example</h3><p><strong>The following content is render from my <a href=https://github.com/ntk148v/til/blob/master/linux/iptables.md>til post</a>.</strong></p><h1 id=iptables>Iptables</h1><p>Source:</p><ul><li><p><a href=https://www.thegeekstuff.com/2011/01/iptables-fundamentals/>https://www.thegeekstuff.com/2011/01/iptables-fundamentals/</a></p></li><li><p><a href=https://www.opsist.com/blog/2015/08/11/how-do-i-see-what-iptables-is-doing.html>https://www.opsist.com/blog/2015/08/11/how-do-i-see-what-iptables-is-doing.html</a></p></li><li><p><a href=https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture>https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture</a></p></li><li><p><a href=https://www.sobyte.net/post/2022-04/understanding-netfilter-and-iptables/>https://www.sobyte.net/post/2022-04/understanding-netfilter-and-iptables/</a> - advanced</p></li><li><p><a href=#iptables>Iptables</a></p><ul><li><a href=#1-introduction>1. Introduction</a></li><li><a href=#2-netfilter-hooks>2. Netfilter hooks</a></li><li><a href=#3-iptables-tables-and-chains>3. iptables tables and chains</a></li><li><a href=#4-iptables-rules>4. iptables rules</a></li><li><a href=#5-iptables-drawbacks>5. iptables drawbacks</a></li><li><a href=#6-iptables-trace>6. iptables TRACE</a></li></ul></li></ul><h2 id=1-introduction>1. Introduction</h2><ul><li>iptables is used to manage packet filtering and NAT rules.</li><li>iptables works with the kernel <code>netfilter</code> packet filtering framework.<ul><li>iptables is replaced with <code>nftables</code>, but <code>iptables</code> syntax is still commonly used as a baseline.</li></ul></li><li>iptables on a high-level.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>iptables
</span></span><span class=line><span class=cl>    tables
</span></span><span class=line><span class=cl>        chains
</span></span><span class=line><span class=cl>            rules
</span></span></code></pre></div><h2 id=2-netfilter-hooks>2. Netfilter hooks</h2><ul><li>There are 4 netfilter hooks that programs can register with. As packets progress through the stack, they will trigger the kernel modules that have registered with these hooks.<ul><li><code>NF_IP_PRE_ROUTING</code>: triggered by any incoming traffic very soon after entering network stack. This hook is processed before any routing decisions have been made regarding where to send the packet.</li><li><code>NF_IP_LOCAL_IN</code>: triggered after an incoming packet has been routed if the packet is destined for the local system.</li><li><code>NF_IP_FORWARD</code>: triggered after an incoming packet has been routed if the packet is to be forwarded to another host.</li><li><code>NF_IP_LOCAL_OUT</code>: triggered by any locally created outbound traffic as soon as it hits the network stack.</li><li><code>NF_IP_POST_ROUTING</code>: triggerd by any outgoing or forwarded traffic after routing has taken place and just before being sent out on the wire.</li></ul></li></ul><p><img src=https://people.netfilter.org/pablo/nf-hooks.png alt></p><h2 id=3-iptables-tables-and-chains>3. iptables tables and chains</h2><ul><li>The names of the built-in chains mirror the names of the netfilter hooks they are associated with:<ul><li><code>PREROUTING</code>: Triggered by the <code>NF_IP_PRE_ROUTING</code> hook.</li><li><code>INPUT</code>: Triggered by the <code>NF_IP_LOCAL_IN</code> hook.</li><li><code>FORWARD</code>: Triggered by the <code>NF_IP_FORWARD</code> hook.</li><li><code>OUTPUT</code>: Triggered by the <code>NF_IP_LOCAL_OUT</code> hook.</li><li><code>POSTROUTING</code>: Triggered by the <code>NF_IP_POST_ROUTING</code> hook.</li></ul></li><li>iptables has the following 4 (or 5 in RedHat/CentOS) built-in tables.<ul><li>Filter table: default table, built-in chains:<ul><li>INPUT chain: incoming to firewall. For packets coming to the local server.</li><li>OUTPUT chain: outgoing from firewall. For packets generated locally and going out of the local server.</li><li>FORWARD chain: Packet for another NIC on the local server. For packets routed through the local server.</li></ul></li><li>NAT table: built-in chains, is used to implement network address translation rules. As packets enter the network stack, rules in this table will determine whether and how modify the packet&rsquo;s source or destination addresses in order to impact the way that the packet and any response traffic are routed.<ul><li>PREROUTING chain: alters packets before routing, i.e Packet translation happens immediately after the packet comes to the system (and before routing). This helps to translate the destination ip address of the packets to something that matches the routing on the local server -> DNAT.</li><li>POSTROUTING chain: alters packets after routing, i.e Packet translation happens when the packets are leaving the system. This helps to translate the source ip address of the packets to something that might match the routing on the destination server -> SNAT.</li><li>OUTPUT chain: NAT for locally generated packets on the firewall.</li></ul></li><li>Mangle table: is used to alter the IP headers of the packet in various way (for e.x., adjust the TTL,&mldr;) Mangle table has the following built-in chains:<ul><li>PREROUTING chain</li><li>OUTPUT chain</li><li>FORWARD chain</li><li>INPUT chain</li><li>POSTROUTING chain</li></ul></li><li>Raw table: iptables firewall is stateful, meaning that packets are evaluated in regards to their relation to previous packets. The connection tracking features built on top of the <code>netfilter</code> framework allow <code>iptables</code> to view packets as part of an ongoing connection or session instead of as a stream of discrete, unrelated packets. The connection tracking logic is usually applied very soon after the packet hits the network interface. The <code>raw</code> table has a very narrowly defined function. Its only purpose is to provide a mechanism for marking packets in order to opt-out of connection tracking. Raw table has the following built-in chains:<ul><li>PREROUTING chain.</li><li>OUTPUT chain.</li></ul></li><li>Security table (RedHat/CentOS distros only): is used to set internal SELinux security context marks on packets, which will affect how SELinux or other systems that can interpret SELinux security contexts handle the packets.</li></ul></li><li>Process flow:</li></ul><p><img src=https://stuffphilwrites.com/wp-content/uploads/2014/09/FW-IDS-iptables-Flowchart-v2019-04-30-1.png alt></p><ul><li>You can follow TRACE tutorial bellow to get process flow.</li><li>Tables & Chains relationship.</li></ul><table><thead><tr><th></th><th>PREROUTING</th><th>INPUT</th><th>FORWARD</th><th>OUTPUT</th><th>POSTROUTING</th></tr></thead><tbody><tr><td>(routing decision)</td><td></td><td></td><td></td><td>x</td><td></td></tr><tr><td>raw</td><td>x</td><td></td><td></td><td>x</td><td></td></tr><tr><td>(connection tracking enabled)</td><td>x</td><td></td><td></td><td>x</td><td></td></tr><tr><td>mangle</td><td>x</td><td>x</td><td>x</td><td>x</td><td>x</td></tr><tr><td>nat (DNAT)</td><td>x</td><td></td><td></td><td>x</td><td></td></tr><tr><td>(routing decision)</td><td>x</td><td></td><td></td><td>x</td><td></td></tr><tr><td>filter</td><td></td><td>x</td><td>x</td><td>x</td><td></td></tr><tr><td>security</td><td></td><td>x</td><td>x</td><td>x</td><td></td></tr><tr><td>nat (SNAT)</td><td></td><td>x</td><td></td><td></td><td>x</td></tr></tbody></table><ul><li>Chain traversal order: Assuming that the server knows how to route a packet and that the firewall rules permit its transmission, the following flows represent the paths that will be traversed in different situations:<ul><li>Incoming packets destined for the local system: PREROUTING (raw, mangle, nat) -> INPUT (mangle, filter, security, nat)</li><li>Incoming packets destined to another host: PREROUTING -> FORWARD -> POSTROUTING</li><li>Locally generated packets: OUTPUT -> POSTROUTING</li></ul></li></ul><h2 id=4-iptables-rules>4. iptables rules</h2><ul><li>Key points:<ul><li>Rules contain a criteria and a target.</li><li>If the criteria is matched, it goes to the rules specified in the target (or) executes the special values mentioned in the target.</li><li>If the criteria is not matched, it moves on to the next rule.</li></ul></li><li>Target values:<ul><li>ACCEPT – Firewall will accept the packet.</li><li>DROP – Firewall will drop the packet.</li><li>QUEUE – Firewall will pass the packet to the userspace.</li><li>RETURN – Firewall will stop executing the next set of rules in the current chain for this packet. The control will be returned to the calling chain.</li></ul></li><li>Available states: connection tracked by the connection tracking system will be in one of the following states:<ul><li><code>NEW</code>:</li><li><code>ESTABLISHED</code>:</li><li><code>RELATED</code>:</li><li><code>INVALID</code>:</li><li><code>UNTRACKED</code>:</li><li><code>SNAT</code>:</li><li><code>DNAT</code>:</li></ul></li><li>Check rules</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># num – Rule number within the particular chain</span>
</span></span><span class=line><span class=cl><span class=c1># target – Special target variable that we discussed above</span>
</span></span><span class=line><span class=cl><span class=c1># prot – Protocols. tcp, udp, icmp, etc.,</span>
</span></span><span class=line><span class=cl><span class=c1># opt – Special options for that specific rule.</span>
</span></span><span class=line><span class=cl><span class=c1># source – Source ip-address of the packet</span>
</span></span><span class=line><span class=cl><span class=c1># destination – Destination ip-address for the packet</span>
</span></span><span class=line><span class=cl>iptables --list
</span></span><span class=line><span class=cl>iptables -t nat --list
</span></span></code></pre></div><h2 id=5-iptables-drawbacks>5. iptables drawbacks</h2><ul><li>Lack of incremental updates.</li><li>Performance:<ul><li>iptables rules are global &ndash;> For every packet, incoming interface needs to be checked and execution of rules branched to the set of rules appropriate for the particular interface.</li><li>Switch context.</li></ul></li><li>&mldr;</li></ul><h2 id=6-iptables-trace>6. iptables TRACE</h2><ul><li>Ubuntu 22.04</li><li>Copy this scrip to <code>iptables-trace.sh</code>.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>if</span> <span class=o>[</span> <span class=nv>$#</span> !<span class=o>=</span> <span class=s2>&#34;2&#34;</span> <span class=o>]</span> <span class=o>||</span> ! <span class=o>[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>2</span><span class=si>}</span><span class=s2>&#34;</span> -eq <span class=s2>&#34;</span><span class=si>${</span><span class=nv>2</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>]</span> 2&gt; /dev/null
</span></span><span class=line><span class=cl><span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=si>${</span><span class=nv>1</span><span class=si>}</span> !<span class=o>=</span> <span class=s2>&#34;enable&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> <span class=si>${</span><span class=nv>1</span><span class=si>}</span> !<span class=o>=</span> <span class=s2>&#34;disable&#34;</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Usage: </span><span class=si>${</span><span class=nv>0</span><span class=si>}</span><span class=s2> [enable|disable] port&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=si>${</span><span class=nv>1</span><span class=si>}</span> <span class=o>=</span> <span class=s2>&#34;enable&#34;</span> <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=k>then</span>
</span></span><span class=line><span class=cl>    modprobe nf_log_ipv4
</span></span><span class=line><span class=cl>    sysctl -w net.netfilter.nf_log.2<span class=o>=</span>nf_log_ipv4
</span></span><span class=line><span class=cl>    iptables -t raw -A PREROUTING -p tcp --dport <span class=si>${</span><span class=nv>2</span><span class=si>}</span> -j TRACE
</span></span><span class=line><span class=cl>    iptables -t raw -A OUTPUT -p tcp --dport <span class=si>${</span><span class=nv>2</span><span class=si>}</span> -j TRACE
</span></span><span class=line><span class=cl>    iptables -t raw -A PREROUTING -p udp --dport <span class=si>${</span><span class=nv>2</span><span class=si>}</span> -j TRACE
</span></span><span class=line><span class=cl>    iptables -t raw -A OUTPUT -p udp --dport <span class=si>${</span><span class=nv>2</span><span class=si>}</span> -j TRACE
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;iptables trace is enabled for port </span><span class=si>${</span><span class=nv>2</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;run \&#34;xtables-monitor -t\&#34; to view trace&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    iptables -t raw -D OUTPUT -p tcp --dport <span class=si>${</span><span class=nv>2</span><span class=si>}</span> -j TRACE
</span></span><span class=line><span class=cl>    iptables -t raw -D PREROUTING -p tcp --dport <span class=si>${</span><span class=nv>2</span><span class=si>}</span> -j TRACE
</span></span><span class=line><span class=cl>    iptables -t raw -D OUTPUT -p udp --dport <span class=si>${</span><span class=nv>2</span><span class=si>}</span> -j TRACE
</span></span><span class=line><span class=cl>    iptables -t raw -D PREROUTING -p udp --dport <span class=si>${</span><span class=nv>2</span><span class=si>}</span> -j TRACE
</span></span><span class=line><span class=cl>    sysctl -w net.netfilter.nf_log.2<span class=o>=</span>NONE
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;iptables trace is disabled for port </span><span class=si>${</span><span class=nv>2</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></div><ul><li>Enable tracing.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>iptables-trace <span class=nb>enable</span> <span class=m>8000</span>
</span></span><span class=line><span class=cl>xtables-monitor -t
</span></span></code></pre></div><ul><li>Disable tracing.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>iptables-trace disable <span class=m>8000</span>
</span></span></code></pre></div><ul><li><p>Note that, you may find there is some sources that configures trace, then uses rsyslog/dmesg (check <code>/var/log/kern.log</code>). But it may not work (in my case), cause this is iptables-legacy method. Your system switched to iptables-over-nftables.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ update-alternatives --list iptables
</span></span><span class=line><span class=cl>/usr/sbin/iptables-legacy
</span></span><span class=line><span class=cl>/usr/sbin/iptables-nft
</span></span><span class=line><span class=cl>$ update-alternatives --display iptables
</span></span><span class=line><span class=cl>iptables - auto mode
</span></span><span class=line><span class=cl>  link best version is /usr/sbin/iptables-nft
</span></span><span class=line><span class=cl>  link currently points to /usr/sbin/iptables-nft
</span></span><span class=line><span class=cl>  link iptables is /usr/sbin/iptables
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span></code></pre></div><ul><li>The <code>TRACE</code> target framework is specifically diefferent with this variant, to benefit from the advantages of the <em>nftables</em> API. It&rsquo;s described in the manuals for the <a href=https://manpages.debian.org/iptables/iptables-extensions.8#TRACE>iptables TRACE target</a> and <a href=https://manpages.debian.org/iptables/xtables-monitor.8>xtables-monitor</a>.</li><li>That means a lot of documentation and many blogs are becoming stale and showing only the legacy method.</li><li>Now with iptables-nft, one can just run this to display traces:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>xtables-monitor -t
</span></span></code></pre></div></li></ul></div><div class=mt-16></div></article></div></main><footer class="fixed left-0 bottom-0 w-full bg-base px-page-gutter"><div class="flex justify-center items-center h-footer-height"><div class="flex flex-row w-full max-w-content justify-between lowercase italic gap-3"><nav><ul class="flex text-md space-x-3 sm:space-x-6"><li class=text-text><a href=/hugo-toigian/about class="tracking-wide hover:underline">About</a></li><li class=text-text><a href=/hugo-toigian/posts class="tracking-wide hover:underline">Posts</a></li></ul></nav><span class="text-muted hidden md:block">&copy;
2023
<a href=https://github.com/ntk148v/hugo-toigian class="font-bold hover:underline">hugo-toigian</a></span><div id=header-theme-button><svg id="dark_mode_btn" class="hidden toolbox-btn" width="18" height="18" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718.0 0118 15.75c-5.385.0-9.75-4.365-9.75-9.75.0-1.33.266-2.597.748-3.752A9.753 9.753.0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753.0 009.002-5.998z"/></svg><svg id="light_mode_btn" class="hidden toolbox-btn" width="18" height="18" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75.0 11-7.5.0 3.75 3.75.0 017.5.0z"/></svg></div></div></div></footer></body></html>